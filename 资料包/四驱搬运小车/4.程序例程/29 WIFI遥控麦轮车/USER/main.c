/***************************************************************************
本程序可供学习使用，经作者允许，也可用于其他用途。如有意见及建议，欢迎来电交流指教
硬件版本：四路麦轮多功能控制板
主控芯片：STM32F103RCT6
程序名称：STM32麦轮全向移动小车程序--主程序
功能描述：通过手机WIFI APP无线遥控麦克纳姆轮小车全向移动



*****************************************************************************/



#include "UI.h"


int main(void)
{	
  Stm32_Clock_Init(9);//系统时钟设置
	JTAG_Set(JTAG_SWD_DISABLE); 
	AFIO->MAPR|=0x1<<8;	//部分重映射，CH1---PA15,CH2---PB3
	JTAG_Set(SWD_ENABLE); 
	delay_init(72);			//延时初始化
	KEY_Init();         //KEY初始化
	LED_Init();         //LED初始化	 
	BEEP_Init();
	OLED_Init();
	OLED_Draw_FreeLink();			//显示图标
	OLED_Refresh_AllGDRAM(); 	//刷新显示
	delay_ms(1000);
	USART3_Init(36,115200);		//初始化蓝牙串口通信接口
	MYDMA_Config(DMA1_Channel3,(u32)&USART3->DR,(u32)Blue_dat,UART_RECV_LEN);//DMA1通道4,外设为串口1,存储器为SendBuff,长度200.
	OLED_ClearBuffer(0);
	OLED_Put12x12CNstr(0,20,"Init WIFI Server",1);
	OLED_Refresh_AllGDRAM(); 	//刷新显示
	while(!init_server()) {delay_ms(200);}
	
 	Motor_Init();				//PWM输出初始化	
  Encoder_Init();			//初始化编码器
 	Set_Motor(0,0,0,0);	//电机PWM输出
	Adc_Init();				 	//初始化ADC，检测电池电压
	PID_Init();
	Flash_Read_MotorDrctAdj();//读取电机转向调整值
	Flash_Read_Language();		//界面语言设置
	Flash_Read_VoltWarn();		//读取报警电压
	TIM6_Int_Init(49,7199);	  //40ms中断溢出
	Blue_RC[0]=0;Blue_RC[1]=0;Blue_RC[2]=0;
	
	UI_Display_Flag=1;				//标记改变界面	

	LED0=1;
	BEEP_state=BEEP_SHORT2FLASH;BEEP_timetick=1;
	while(1)
	{		
		if(Control_Flag)
		{	
			switch(WorkMode)
			{
	////////////////////待机模式////////////////////////
				case 0:
					Standby_Mode();
				break;
	////////////////////设置模式////////////////////////
				case 1:
					Settings_Mode();
					break;	
	////////////////////PID设置////////////////////////
				case 2:
					PID_Settings();
					break;
	/////////////////////电机设置//////////////////////
				case 3:
					Motor_Settings();
					break;
	/////////////////////角度校准//////////////////////
				case 4:
//					AdjustAngle_Settings();
				break;
	/////////////////////速度设定//////////////////////	
				case 5:break;
	/////////////////////语言设置//////////////////////		
				case 6:LanguageSettings_Mode();break;
	/////////////////////出厂设置//////////////////////		
				case 7:FactorySettings_Mode();break;						
	/////////////////////其他设置//////////////////////		
				case 8:Other_Settings_Mode();break;
	/////////////////////电压低报警////////////////////						
				case 10:VoltWarn_Mode();break;

	////////////////////遥控模式////////////////////////
				case 14:
				case 13://PS遥控
				case 11:
				case 12:
				
					Remote_Mode();
				break;	
				default:			break;
			}
			Control_Flag=0;
			if(AdjustAngle_Flag>0)	AdjustAngle_Flag--;	
//			Send_Data();	//发送数据
			Volt=Get_Adc(4);Volt=Volt*33*11/4096;	//检测电压
			if(WorkMode==0x00 || WorkMode==0x01)
			{
				if( Volt<VoltLowWarn) 
				{
					if(VoltLowTimes<600)VoltLowTimes++;
					else {WorkMode=0x0A;ARMED=0;time_tick=0;}
				}
				else	VoltLowTimes=0;
			}
		}
		
		OLED_Refresh_AllGDRAM(); 	//刷新显示
	} 
}













